<html>

<head>

</head>

<body>
    <h1>
        Full text search test
    </h1>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.0.4/fuse.min.js"></script>
    <script>
        var textSearch = "124 ม.4 ต.สุขสวัสดิ์ อ.ไพรบึง จ.ศรีสะเกษ 33180"
        fullTextSearchAddress(textSearch, {
            zipFilter: true
        }).then(data => {
            console.log(data)
        })

        function fullTextSearchAddress(text, options = {}, searchOptions = null) {
            // default setting
            let defaultDatabaseUrl =
                "https://raw.githubusercontent.com/earthchie/jquery.Thailand.js/master/jquery.Thailand.js/database/raw_database/raw_database.json"

            let textSearch = text
            let dbUrl = options.url || defaultDatabaseUrl
            let zipFilter = options.zipFilter || false

            return new Promise(function (resolve, reject) {
                fetch(dbUrl)
                    .then(function (response) {
                        return response.json()
                    })
                    .then(function (result) {
                        if (zipFilter) {
                            let regxpZip = textSearch.match(/\d{5}/)
                            result = filterByZip(result, parseInt(regxpZip[0]))
                        }
                        let fuseOptions = {
                            caseSensitive: true,
                            shouldSort: true,
                            tokenize: true,
                            includeScore: true,
                            threshold: 0.6,
                            location: 0,
                            distance: 100,
                            maxPatternLength: 100,
                            minMatchCharLength: 1,
                            keys: [
                                "district",
                                "amphoe",
                                "province",
                                "zipcode"
                            ]
                        }
                        if (searchOptions !== null && typeof searchOptions === 'object') {
                            fuseOptions = searchOptions
                        }
                        let fuse = new Fuse(result, fuseOptions)
                        let search = fuse.search(textSearch)

                        if (options.limit) {
                            let limitSearch = limitResult(search, options.limit)
                            resolve(limitSearch)
                        }
                        resolve(search)
                    })
            })
        }

        function limitResult(dataArr, limit = 30) {
            let result = []
            for (let i = 0; i < limit; i++) {
                result.push(dataArr[i])
            }
            return result
        }

        function filterByZip(dataArr, zipcode) {
            let result = dataArr.filter(function (data) {
                return data.zipcode === zipcode
            })
            return result
        }
    </script>
</body>

</html>